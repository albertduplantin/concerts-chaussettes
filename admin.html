<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Concert Chaussettes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Navigation */
        .nav {
            background: #1a1a2e;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-brand {
            color: white;
            font-size: 1.4rem;
            font-weight: bold;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            gap: 5px;
        }

        .nav-link {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-link.active {
            background: #667eea;
        }

        .nav-external {
            color: #667eea;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid #667eea;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-external:hover {
            background: #667eea;
            color: white;
        }

        /* Main content */
        .main {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .page.active {
            display: block;
        }

        h1 {
            color: #1a1a2e;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card.gold {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #1a1a2e;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-gold {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: white;
        }

        /* Participation count */
        .participation-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .participation-badge.high {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: white;
        }

        .participation-badge.medium {
            background: #667eea;
            color: white;
        }

        .participation-badge.low {
            background: #e0e0e0;
            color: #666;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #ddd;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        /* Checkbox */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                gap: 15px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }

            .main {
                padding: 15px;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <a href="/" class="nav-brand">Concert Chaussettes - Admin</a>
        <div class="nav-menu">
            <a href="#dashboard" class="nav-link active" data-page="dashboard">Tableau de bord</a>
            <a href="#inscrits" class="nav-link" data-page="inscrits">Inscrits</a>
            <a href="#contacts" class="nav-link" data-page="contacts">Contacts</a>
            <a href="#events" class="nav-link" data-page="events">Événements</a>
            <a href="#email" class="nav-link" data-page="email">Emailing</a>
            <a href="/admin/" class="nav-external" target="_blank">CMS</a>
        </div>
    </nav>

    <main class="main">
        <!-- Dashboard -->
        <div id="dashboard" class="page active">
            <h1>Tableau de bord</h1>
            <p class="subtitle">Vue d'ensemble de votre événement</p>

            <div class="stats">
                <div class="stat-card">
                    <h3 id="stat-inscrits">-</h3>
                    <p>Inscrits</p>
                </div>
                <div class="stat-card green">
                    <h3 id="stat-places">-</h3>
                    <p>Places totales</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-contacts">-</h3>
                    <p>Contacts</p>
                </div>
                <div class="stat-card gold">
                    <h3 id="stat-actifs">-</h3>
                    <p>Contacts actifs (2+ events)</p>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="syncRegistrationsToContacts()">
                    Importer inscrits vers contacts
                </button>
            </div>

            <div id="sync-result" class="alert alert-info" style="display: none;"></div>

            <h2 style="margin-top: 30px; margin-bottom: 15px;">Top contacts les plus actifs</h2>
            <table>
                <thead>
                    <tr>
                        <th>Contact</th>
                        <th>Email</th>
                        <th>Participations</th>
                    </tr>
                </thead>
                <tbody id="top-contacts-body">
                    <tr><td colspan="3" class="loading">Chargement...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Inscrits -->
        <div id="inscrits" class="page">
            <h1>Liste des inscrits</h1>
            <p class="subtitle">Gestion des inscriptions à l'événement en cours</p>

            <div class="stats">
                <div class="stat-card">
                    <h3 id="inscrits-count">-</h3>
                    <p>Inscrits</p>
                </div>
                <div class="stat-card green">
                    <h3 id="inscrits-places">-</h3>
                    <p>Places réservées</p>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="exportInscrits()">Exporter CSV</button>
                <button class="btn btn-success" onclick="exportInscritsPDF()">Exporter PDF</button>
                <button class="btn btn-danger" onclick="deleteAllRegistrations()">Tout supprimer</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Téléphone</th>
                        <th>Accompagnants</th>
                        <th>Date inscription</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inscrits-body">
                    <tr><td colspan="6" class="loading">Chargement...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Contacts -->
        <div id="contacts" class="page">
            <h1>Liste de diffusion</h1>
            <p class="subtitle">Gestion des contacts pour les mailings</p>

            <div class="tabs">
                <button class="tab active" data-tab="contacts-list">Contacts</button>
                <button class="tab" data-tab="contacts-import">Importer</button>
                <button class="tab" data-tab="contacts-add">Ajouter</button>
            </div>

            <!-- Contacts List Tab -->
            <div id="contacts-list" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="contacts-count">-</h3>
                        <p>Total contacts</p>
                    </div>
                    <div class="stat-card green">
                        <h3 id="contacts-subscribed">-</h3>
                        <p>Abonnés actifs</p>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="exportContacts()">Exporter CSV</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-contacts" onchange="toggleAllContacts()"></th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Téléphone</th>
                            <th>Participations</th>
                            <th>Source</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contacts-body">
                        <tr><td colspan="7" class="loading">Chargement...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Import Tab -->
            <div id="contacts-import" class="tab-content">
                <h2>Importer des contacts</h2>
                <p style="margin-bottom: 20px; color: #666;">Importez des contacts depuis un fichier Excel (.xlsx) ou CSV</p>

                <div class="form-group">
                    <label for="import-file">Fichier Excel/CSV</label>
                    <input type="file" id="import-file" accept=".xlsx,.xls,.csv">
                </div>

                <div class="alert alert-info">
                    <strong>Format attendu :</strong> Le fichier doit contenir les colonnes suivantes (l'ordre n'importe pas) :
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Prénom (ou first_name ou firstName)</li>
                        <li>Nom (ou last_name ou lastName)</li>
                        <li>Email (ou email ou mail)</li>
                        <li>Téléphone (optionnel : phone ou tel ou telephone)</li>
                    </ul>
                </div>

                <button class="btn btn-success" onclick="importContactsFile()">Importer</button>

                <div id="import-result" class="alert" style="display: none; margin-top: 20px;"></div>
            </div>

            <!-- Add Contact Tab -->
            <div id="contacts-add" class="tab-content">
                <h2>Ajouter un contact</h2>

                <form id="add-contact-form" onsubmit="addContact(event)">
                    <div class="form-group">
                        <label for="contact-firstname">Prénom *</label>
                        <input type="text" id="contact-firstname" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-lastname">Nom *</label>
                        <input type="text" id="contact-lastname" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-email">Email *</label>
                        <input type="email" id="contact-email" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-phone">Téléphone</label>
                        <input type="tel" id="contact-phone">
                    </div>
                    <button type="submit" class="btn btn-success">Ajouter le contact</button>
                </form>
            </div>
        </div>

        <!-- Events -->
        <div id="events" class="page">
            <h1>Événements</h1>
            <p class="subtitle">Gestion des événements et concerts</p>

            <div class="tabs">
                <button class="tab active" data-tab="events-list">Événements</button>
                <button class="tab" data-tab="events-add">Créer un événement</button>
            </div>

            <!-- Events List Tab -->
            <div id="events-list" class="tab-content active">
                <table>
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Date</th>
                            <th>Lieu</th>
                            <th>Statut</th>
                            <th>Participants</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="events-body">
                        <tr><td colspan="6" class="loading">Chargement...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Add Event Tab -->
            <div id="events-add" class="tab-content">
                <h2>Créer un événement</h2>

                <form id="add-event-form" onsubmit="addEvent(event)">
                    <div class="form-group">
                        <label for="event-name">Nom de l'événement *</label>
                        <input type="text" id="event-name" required>
                    </div>
                    <div class="form-group">
                        <label for="event-date">Date</label>
                        <input type="datetime-local" id="event-date">
                    </div>
                    <div class="form-group">
                        <label for="event-venue">Lieu</label>
                        <input type="text" id="event-venue">
                    </div>
                    <div class="form-group">
                        <label for="event-description">Description</label>
                        <textarea id="event-description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Créer l'événement</button>
                </form>
            </div>
        </div>

        <!-- Email -->
        <div id="email" class="page">
            <h1>Emailing</h1>
            <p class="subtitle">Envoyez des emails à vos contacts</p>

            <div class="form-group">
                <label for="email-template">Choisir un modèle</label>
                <select id="email-template" onchange="loadTemplate()">
                    <option value="">-- Sélectionner un modèle --</option>
                    <option value="invitation">Invitation</option>
                    <option value="reminder">Rappel</option>
                    <option value="custom">Personnalisé</option>
                </select>
            </div>

            <div class="form-group">
                <label for="email-recipients">Destinataires</label>
                <select id="email-recipients">
                    <option value="all">Tous les contacts abonnés</option>
                    <option value="selected">Contacts sélectionnés (depuis l'onglet Contacts)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="email-subject">Sujet *</label>
                <input type="text" id="email-subject" required>
            </div>

            <div class="form-group">
                <label for="email-content">Contenu HTML *</label>
                <textarea id="email-content" rows="15" required></textarea>
            </div>

            <div class="alert alert-info">
                <strong>Variables disponibles :</strong>
                <code>{{artist_name}}</code>, <code>{{date}}</code>, <code>{{venue}}</code>,
                <code>{{address}}</code>, <code>{{time}}</code>, <code>{{price}}</code>,
                <code>{{site_url}}</code>, <code>{{unsubscribe_link}}</code>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="previewEmail()">Prévisualiser</button>
                <button class="btn btn-success" onclick="sendEmails()">Envoyer</button>
            </div>

            <div id="email-preview" style="display: none; margin-top: 20px; border: 2px solid #ddd; border-radius: 8px; padding: 20px; background: #fafafa;">
                <h3 style="margin-bottom: 15px;">Aperçu</h3>
                <div id="email-preview-content"></div>
            </div>
        </div>
    </main>

    <!-- Modal for contact history -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historique des participations</h2>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div id="history-content">
                <p class="loading">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Modal for editing inscrit -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier l'inscription</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-inscrit-form" onsubmit="updateInscrit(event)">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label for="edit-name">Nom</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" required>
                </div>
                <div class="form-group">
                    <label for="edit-phone">Téléphone</label>
                    <input type="tel" id="edit-phone" required>
                </div>
                <div class="form-group">
                    <label for="edit-guests">Nombre de personnes</label>
                    <input type="number" id="edit-guests" min="1" max="7" required>
                </div>
                <button type="submit" class="btn btn-success">Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- SheetJS for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Global state
        let contactsData = [];
        let selectedContacts = new Set();
        let concertData = null;
        let eventsData = [];

        // Navigation
        document.querySelectorAll('.nav-link[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.target.dataset.page;
                showPage(page);
            });
        });

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabId = e.target.dataset.tab;
                const parent = e.target.closest('.page');

                parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                e.target.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');

            // Load data for the page
            if (pageId === 'inscrits') loadInscrits();
            if (pageId === 'contacts') loadContacts();
            if (pageId === 'events') loadEvents();
        }

        // Load concert data
        async function loadConcertData() {
            try {
                const response = await fetch('/content/concert.json');
                if (response.ok) {
                    concertData = await response.json();
                }
            } catch (e) {
                console.error('Error loading concert data:', e);
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                // Load registrations count
                const regResponse = await fetch('/api/get-registrations');
                const regData = await regResponse.json();
                const registrations = Array.isArray(regData) ? regData : (regData.registrations || []);
                const totalPlaces = registrations.reduce((sum, r) => sum + (r.guests || 1), 0);
                document.getElementById('stat-inscrits').textContent = registrations.length;
                document.getElementById('stat-places').textContent = totalPlaces;

                // Load contacts with stats
                const contactsResponse = await fetch('/api/get-contacts-with-stats');
                const contactsData = await contactsResponse.json();
                const contacts = Array.isArray(contactsData) ? contactsData : [];
                document.getElementById('stat-contacts').textContent = contacts.length;

                const activeContacts = contacts.filter(c => parseInt(c.participationCount) >= 2).length;
                document.getElementById('stat-actifs').textContent = activeContacts;

                // Display top contacts
                const topBody = document.getElementById('top-contacts-body');
                const top10 = contacts.slice(0, 10);

                if (top10.length === 0) {
                    topBody.innerHTML = '<tr><td colspan="3">Aucun contact</td></tr>';
                } else {
                    topBody.innerHTML = top10.map(c => `
                        <tr>
                            <td>${c.firstName} ${c.lastName}</td>
                            <td>${c.email}</td>
                            <td>
                                <span class="participation-badge ${parseInt(c.participationCount) >= 3 ? 'high' : parseInt(c.participationCount) >= 1 ? 'medium' : 'low'}">
                                    ${c.participationCount} événement(s)
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Error loading dashboard:', e);
            }
        }

        // Sync registrations to contacts
        async function syncRegistrationsToContacts() {
            const resultDiv = document.getElementById('sync-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info';
            resultDiv.textContent = 'Synchronisation en cours...';

            try {
                // Get active event
                let eventId = null;
                if (eventsData.length > 0) {
                    const activeEvent = eventsData.find(e => e.isActive);
                    if (activeEvent) eventId = activeEvent.id;
                }

                const response = await fetch('/api/sync-registrations-to-contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ eventId })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <strong>Synchronisation terminée !</strong><br>
                        Total traité : ${result.summary.total}<br>
                        Nouveaux contacts : ${result.summary.imported}<br>
                        Déjà existants : ${result.summary.existing}<br>
                        Participations ajoutées : ${result.summary.participationsAdded}
                    `;
                    loadDashboard();
                } else {
                    throw new Error(result.error);
                }
            } catch (e) {
                resultDiv.className = 'alert alert-warning';
                resultDiv.textContent = 'Erreur : ' + e.message;
            }
        }

        // Inscrits
        async function loadInscrits() {
            try {
                const response = await fetch('/api/get-registrations');
                const data = await response.json();
                const registrations = Array.isArray(data) ? data : (data.registrations || []);

                const totalPlaces = registrations.reduce((sum, r) => sum + (r.guests || 1), 0);
                document.getElementById('inscrits-count').textContent = registrations.length;
                document.getElementById('inscrits-places').textContent = totalPlaces;

                const tbody = document.getElementById('inscrits-body');

                if (registrations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">Aucune inscription</td></tr>';
                    return;
                }

                tbody.innerHTML = registrations.map(r => `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.email}</td>
                        <td>${r.phone}</td>
                        <td>${r.guests}</td>
                        <td>${new Date(r.registeredAt).toLocaleDateString('fr-FR')}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editInscrit(${r.id}, '${r.name.replace(/'/g, "\\'")}', '${r.email}', '${r.phone}', ${r.guests})">Modifier</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInscrit(${r.id})">Supprimer</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading inscrits:', e);
            }
        }

        function editInscrit(id, name, email, phone, guests) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-phone').value = phone;
            document.getElementById('edit-guests').value = guests;
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function updateInscrit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                id: parseInt(id),
                name: document.getElementById('edit-name').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                guests: parseInt(document.getElementById('edit-guests').value)
            };

            try {
                const response = await fetch('/api/update-registration', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeEditModal();
                    loadInscrits();
                    alert('Inscription mise à jour !');
                } else {
                    alert('Erreur lors de la mise à jour');
                }
            } catch (e) {
                alert('Erreur : ' + e.message);
            }
        }

        async function deleteInscrit(id) {
            if (!confirm('Supprimer cette inscription ?')) return;

            try {
                const response = await fetch('/api/delete-registration-by-id', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (response.ok) {
                    loadInscrits();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (e) {
                alert('Erreur : ' + e.message);
            }
        }

        async function deleteAllRegistrations() {
            if (!confirm('ATTENTION : Supprimer TOUTES les inscriptions ?')) return;
            if (!confirm('Cette action est irréversible. Confirmer ?')) return;

            try {
                const response = await fetch('/api/delete-all-registrations', { method: 'DELETE' });
                if (response.ok) {
                    loadInscrits();
                    alert('Toutes les inscriptions ont été supprimées');
                }
            } catch (e) {
                alert('Erreur : ' + e.message);
            }
        }

        async function exportInscrits() {
            try {
                const response = await fetch('/api/get-registrations');
                const result = await response.json();
                const data = Array.isArray(result) ? result : (result.registrations || []);

                if (data.length === 0) {
                    alert('Aucun inscrit à exporter');
                    return;
                }

                const csv = ['Nom,Email,Téléphone,Accompagnants,Date'].concat(
                    data.map(r => `"${r.name}","${r.email}","${r.phone}",${r.guests},"${new Date(r.registeredAt).toLocaleDateString('fr-FR')}"`)
                ).join('\n');

                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'inscrits.csv';
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('Error exporting CSV:', e);
                alert('Erreur lors de l\'export CSV: ' + e.message);
            }
        }

        async function exportInscritsPDF() {
            try {
                const response = await fetch('/api/get-registrations');
                const result = await response.json();
                const data = Array.isArray(result) ? result : (result.registrations || []);

                if (data.length === 0) {
                    alert('Aucun inscrit à exporter');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Titre
                const eventName = concertData?.artist?.name || 'Concert';
                const eventDate = concertData?.hero?.date_display || '';

                doc.setFontSize(20);
                doc.setTextColor(102, 126, 234);
                doc.text('Liste des Inscrits', 105, 20, { align: 'center' });

                doc.setFontSize(14);
                doc.setTextColor(100);
                doc.text(`${eventName}${eventDate ? ' - ' + eventDate : ''}`, 105, 30, { align: 'center' });

                // Statistiques
                const totalPersonnes = data.reduce((sum, r) => sum + (r.guests || 1), 0);
                doc.setFontSize(11);
                doc.setTextColor(60);
                doc.text(`Total: ${data.length} inscription(s) - ${totalPersonnes} personne(s)`, 105, 40, { align: 'center' });

                // Tableau
                const tableData = data.map((r, index) => [
                    index + 1,
                    r.name,
                    r.email,
                    r.phone,
                    r.guests,
                    new Date(r.registeredAt).toLocaleDateString('fr-FR')
                ]);

                doc.autoTable({
                    startY: 50,
                    head: [['#', 'Nom', 'Email', 'Téléphone', 'Pers.', 'Date']],
                    body: tableData,
                    styles: {
                        fontSize: 9,
                        cellPadding: 3
                    },
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },
                        4: { cellWidth: 15, halign: 'center' },
                        5: { cellWidth: 25 }
                    }
                });

                // Pied de page
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(
                        `Généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')} - Page ${i}/${pageCount}`,
                        105, doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }

                // Téléchargement
                const fileName = `inscrits_${eventName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
            } catch (e) {
                console.error('Error exporting PDF:', e);
                alert('Erreur lors de l\'export PDF: ' + e.message);
            }
        }

        // Contacts
        async function loadContacts() {
            try {
                const response = await fetch('/api/get-contacts-with-stats');
                contactsData = await response.json();

                const subscribed = contactsData.filter(c => c.subscribed).length;
                document.getElementById('contacts-count').textContent = contactsData.length;
                document.getElementById('contacts-subscribed').textContent = subscribed;

                const tbody = document.getElementById('contacts-body');

                if (contactsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">Aucun contact</td></tr>';
                    return;
                }

                tbody.innerHTML = contactsData.map(c => `
                    <tr>
                        <td><input type="checkbox" class="contact-checkbox" data-id="${c.id}" ${selectedContacts.has(c.id) ? 'checked' : ''} onchange="toggleContact(${c.id})"></td>
                        <td>${c.firstName} ${c.lastName}</td>
                        <td>${c.email}</td>
                        <td>${c.phone || '-'}</td>
                        <td>
                            <span class="participation-badge ${parseInt(c.participationCount) >= 3 ? 'high' : parseInt(c.participationCount) >= 1 ? 'medium' : 'low'}"
                                  style="cursor: pointer" onclick="showHistory(${c.id}, '${c.firstName} ${c.lastName}')">
                                ${c.participationCount}
                            </span>
                        </td>
                        <td><span class="badge badge-info">${c.source || 'manual'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteContact(${c.id})">Supprimer</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading contacts:', e);
            }
        }

        function toggleContact(id) {
            if (selectedContacts.has(id)) {
                selectedContacts.delete(id);
            } else {
                selectedContacts.add(id);
            }
        }

        function toggleAllContacts() {
            const checked = document.getElementById('select-all-contacts').checked;
            contactsData.forEach(c => {
                if (checked) {
                    selectedContacts.add(c.id);
                } else {
                    selectedContacts.delete(c.id);
                }
            });
            loadContacts();
        }

        async function showHistory(contactId, name) {
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');

            modal.classList.add('active');
            content.innerHTML = '<p class="loading">Chargement...</p>';

            try {
                const response = await fetch(`/api/get-participations?contactId=${contactId}`);
                const participations = await response.json();

                if (participations.length === 0) {
                    content.innerHTML = `<p><strong>${name}</strong> n'a participé à aucun événement.</p>`;
                } else {
                    content.innerHTML = `
                        <p style="margin-bottom: 15px;"><strong>${name}</strong> - ${participations.length} participation(s)</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Événement</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${participations.map(p => `
                                    <tr>
                                        <td>${p.event.name}</td>
                                        <td>${p.event.date ? new Date(p.event.date).toLocaleDateString('fr-FR') : '-'}</td>
                                        <td><span class="badge badge-success">${p.participation.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (e) {
                content.innerHTML = '<p>Erreur lors du chargement</p>';
            }
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.remove('active');
        }

        async function deleteContact(id) {
            if (!confirm('Supprimer ce contact ?')) return;

            try {
                const response = await fetch('/api/delete-contact', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (response.ok) {
                    loadContacts();
                }
            } catch (e) {
                alert('Erreur : ' + e.message);
            }
        }

        async function addContact(e) {
            e.preventDefault();

            const data = {
                firstName: document.getElementById('contact-firstname').value,
                lastName: document.getElementById('contact-lastname').value,
                email: document.getElementById('contact-email').value,
                phone: document.getElementById('contact-phone').value
            };

            try {
                const response = await fetch('/api/create-contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('add-contact-form').reset();
                    loadContacts();
                    alert('Contact ajouté !');
                } else {
                    const result = await response.json();
                    alert('Erreur : ' + result.error);
                }
            } catch (e) {
                alert('Erreur : ' + e.message);
            }
        }

        async function importContactsFile() {
            const fileInput = document.getElementById('import-file');
            const resultDiv = document.getElementById('import-result');

            if (!fileInput.files.length) {
                alert('Veuillez sélectionner un fichier');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info';
            resultDiv.textContent = 'Lecture du fichier...';

            try {
                const file = fileInput.files[0];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                if (rows.length === 0) {
                    throw new Error('Fichier vide');
                }

                // Map columns
                const contacts = rows.map(row => ({
                    firstName: row['Prénom'] || row['prenom'] || row['first_name'] || row['firstName'] || '',
                    lastName: row['Nom'] || row['nom'] || row['last_name'] || row['lastName'] || '',
                    email: row['Email'] || row['email'] || row['mail'] || row['EMAIL'] || '',
                    phone: row['Téléphone'] || row['telephone'] || row['phone'] || row['tel'] || ''
                })).filter(c => c.email && c.firstName);

                resultDiv.textContent = `Import de ${contacts.length} contacts...`;

                const response = await fetch('/api/import-contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contacts })
                });

                const result = await response.json();

                resultDiv.className = 'alert alert-success';
                resultDiv.innerHTML = `
                    <strong>Import terminé !</strong><br>
                    Importés : ${result.summary.imported}<br>
                    Ignorés (doublons) : ${result.summary.skipped}
                `;

                loadContacts();
            } catch (e) {
                resultDiv.className = 'alert alert-warning';
                resultDiv.textContent = 'Erreur : ' + e.message;
            }
        }

        function exportContacts() {
            const csv = ['Prénom,Nom,Email,Téléphone,Source,Participations'].concat(
                contactsData.map(c => `"${c.firstName}","${c.lastName}","${c.email}","${c.phone || ''}","${c.source || ''}",${c.participationCount}`)
            ).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contacts.csv';
            a.click();
        }

        // Events
        async function loadEvents() {
            try {
                const response = await fetch('/api/get-events');
                eventsData = await response.json();

                const tbody = document.getElementById('events-body');

                if (eventsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">Aucun événement</td></tr>';
                    return;
                }

                tbody.innerHTML = eventsData.map(e => `
                    <tr>
                        <td>${e.name}</td>
                        <td>${e.date ? new Date(e.date).toLocaleDateString('fr-FR') : '-'}</td>
                        <td>${e.venue || '-'}</td>
                        <td>${e.isActive ? '<span class="badge badge-success">Actif</span>' : '<span class="badge badge-warning">Terminé</span>'}</td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewEventParticipants(${e.id}, '${e.name.replace(/'/g, "\\'")}')">Participants</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading events:', e);
            }
        }

        async function addEvent(e) {
            e.preventDefault();

            const data = {
                name: document.getElementById('event-name').value,
                date: document.getElementById('event-date').value || null,
                venue: document.getElementById('event-venue').value,
                description: document.getElementById('event-description').value
            };

            try {
                const response = await fetch('/api/create-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('add-event-form').reset();
                    loadEvents();
                    alert('Événement créé !');
                } else {
                    const result = await response.json();
                    alert('Erreur : ' + result.error);
                }
            } catch (e) {
                alert('Erreur : ' + e.message);
            }
        }

        async function viewEventParticipants(eventId, eventName) {
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');

            modal.classList.add('active');
            content.innerHTML = '<p class="loading">Chargement...</p>';

            try {
                const response = await fetch(`/api/get-participations?eventId=${eventId}`);
                const participations = await response.json();

                if (participations.length === 0) {
                    content.innerHTML = `<p>Aucun participant pour <strong>${eventName}</strong></p>`;
                } else {
                    content.innerHTML = `
                        <p style="margin-bottom: 15px;"><strong>${eventName}</strong> - ${participations.length} participant(s)</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Accompagnants</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${participations.map(p => `
                                    <tr>
                                        <td>${p.contact.firstName} ${p.contact.lastName}</td>
                                        <td>${p.contact.email}</td>
                                        <td>${p.participation.guests}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (e) {
                content.innerHTML = '<p>Erreur lors du chargement</p>';
            }
        }

        // Email
        function replaceVariables(text) {
            if (!text || !concertData) return text;
            const siteUrl = window.location.origin;
            const price = concertData.registration?.price === 0 ? 'Entrée gratuite' : `${concertData.registration?.price}€`;
            return text
                .replace(/\{\{artist_name\}\}/g, concertData.artist?.name || 'Artiste')
                .replace(/\{\{date\}\}/g, concertData.hero?.date_display || '')
                .replace(/\{\{venue\}\}/g, concertData.venue?.name || '')
                .replace(/\{\{address\}\}/g, concertData.venue?.address || '')
                .replace(/\{\{time\}\}/g, concertData.hero?.time || '')
                .replace(/\{\{price\}\}/g, price)
                .replace(/\{\{site_url\}\}/g, siteUrl)
                .replace(/\{\{unsubscribe_link\}\}/g, `${siteUrl}/unsubscribe`);
        }

        function loadTemplate() {
            const template = document.getElementById('email-template').value;
            if (!template || !concertData?.email_templates) return;

            const tpl = concertData.email_templates[template];
            if (tpl) {
                document.getElementById('email-subject').value = tpl.subject || '';
                document.getElementById('email-content').value = tpl.content || '';
            }
        }

        function previewEmail() {
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;

            const previewDiv = document.getElementById('email-preview');
            const previewContent = document.getElementById('email-preview-content');

            previewDiv.style.display = 'block';
            previewContent.innerHTML = `
                <p><strong>Sujet :</strong> ${replaceVariables(subject)}</p>
                <hr style="margin: 15px 0;">
                <div>${replaceVariables(content)}</div>
            `;
        }

        async function sendEmails() {
            const recipients = document.getElementById('email-recipients').value;
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;

            if (!subject || !content) {
                alert('Veuillez remplir le sujet et le contenu');
                return;
            }

            let toEmails = [];

            if (recipients === 'selected') {
                if (selectedContacts.size === 0) {
                    alert('Veuillez sélectionner des contacts dans l\'onglet Contacts');
                    return;
                }
                toEmails = contactsData.filter(c => selectedContacts.has(c.id)).map(c => c.email);
            } else {
                toEmails = contactsData.filter(c => c.subscribed).map(c => c.email);
            }

            if (toEmails.length === 0) {
                alert('Aucun destinataire');
                return;
            }

            if (!confirm(`Envoyer à ${toEmails.length} destinataire(s) ?`)) return;

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: toEmails,
                        subject: replaceVariables(subject),
                        htmlContent: replaceVariables(content),
                        fromName: concertData?.email_config?.sender_name || 'Concert Chaussettes',
                        fromEmail: concertData?.email_config?.sender_email || 'onboarding@resend.dev'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Emails envoyés avec succès ! (${result.sent} envoyé(s))`);
                } else {
                    alert('Erreur : ' + (result.error || 'Erreur inconnue'));
                }
            } catch (e) {
                alert('Erreur : ' + e.message);
            }
        }

        // Initialize
        async function init() {
            await loadConcertData();
            await loadEvents();
            await loadDashboard();
        }

        // Handle hash navigation
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.replace('#', '');
            if (hash && document.getElementById(hash)) {
                showPage(hash);
            }
        });

        // Check initial hash
        const initialHash = window.location.hash.replace('#', '');
        if (initialHash && document.getElementById(initialHash)) {
            showPage(initialHash);
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        init();
    </script>
</body>
</html>
